"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PipelineBase = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const core_1 = require("@aws-cdk/core");
const blueprint_1 = require("../blueprint");
// v2 - keep this import as a separate section to reduce merge conflict when forward merging with the v2 branch.
// eslint-disable-next-line
const core_2 = require("@aws-cdk/core");
/**
 * A generic CDK Pipelines pipeline
 *
 * Different deployment systems will provide subclasses of `Pipeline` that generate
 * the deployment infrastructure necessary to deploy CDK apps, specific to that system.
 *
 * This library comes with the `CodePipeline` class, which uses AWS CodePipeline
 * to deploy CDK apps.
 *
 * The actual pipeline infrastructure is constructed (by invoking the engine)
 * when `buildPipeline()` is called, or when `app.synth()` is called (whichever
 * happens first).
 */
class PipelineBase extends core_2.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.built = false;
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_PipelineBaseProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, PipelineBase);
            }
            throw error;
        }
        if (props.synth instanceof blueprint_1.ShellStep && !props.synth.primaryOutput) {
            props.synth.primaryOutputDirectory('cdk.out');
        }
        if (!props.synth.primaryOutput) {
            throw new Error(`synthStep ${props.synth} must produce a primary output, but is not producing anything. Configure the Step differently or use a different Step type.`);
        }
        this.synth = props.synth;
        this.waves = [];
        this.cloudAssemblyFileSet = props.synth.primaryOutput;
        core_1.Aspects.of(this).add({ visit: () => this.buildJustInTime() });
    }
    /**
     * Deploy a single Stage by itself
     *
     * Add a Stage to the pipeline, to be deployed in sequence with other
     * Stages added to the pipeline. All Stacks in the stage will be deployed
     * in an order automatically determined by their relative dependencies.
     */
    addStage(stage, options) {
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_AddStageOpts(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addStage);
            }
            throw error;
        }
        if (this.built) {
            throw new Error('addStage: can\'t add Stages anymore after buildPipeline() has been called');
        }
        return this.addWave(stage.stageName).addStage(stage, options);
    }
    /**
     * Add a Wave to the pipeline, for deploying multiple Stages in parallel
     *
     * Use the return object of this method to deploy multiple stages in parallel.
     *
     * Example:
     *
     * ```ts
     * declare const pipeline: pipelines.CodePipeline;
     *
     * const wave = pipeline.addWave('MyWave');
     * wave.addStage(new MyApplicationStage(this, 'Stage1'));
     * wave.addStage(new MyApplicationStage(this, 'Stage2'));
     * ```
     */
    addWave(id, options) {
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_WaveOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addWave);
            }
            throw error;
        }
        if (this.built) {
            throw new Error('addWave: can\'t add Waves anymore after buildPipeline() has been called');
        }
        const wave = new blueprint_1.Wave(id, options);
        this.waves.push(wave);
        return wave;
    }
    /**
     * Send the current pipeline definition to the engine, and construct the pipeline
     *
     * It is not possible to modify the pipeline after calling this method.
     */
    buildPipeline() {
        if (this.built) {
            throw new Error('build() has already been called: can only call it once');
        }
        this.doBuildPipeline();
        this.built = true;
    }
    /**
     * Automatically call 'build()' just before synthesis if the user hasn't explicitly called it yet
     */
    buildJustInTime() {
        if (!this.built) {
            this.buildPipeline();
        }
    }
}
exports.PipelineBase = PipelineBase;
_a = JSII_RTTI_SYMBOL_1;
PipelineBase[_a] = { fqn: "@aws-cdk/pipelines.PipelineBase", version: "1.204.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUtYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBpcGVsaW5lLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0NBQStDO0FBRS9DLDRDQUFxSDtBQUVySCxnSEFBZ0g7QUFDaEgsMkJBQTJCO0FBQzNCLHdDQUEyRDtBQWtCM0Q7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0gsTUFBc0IsWUFBYSxTQUFRLGdCQUFhO0lBb0J0RCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXdCO1FBQ2hFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFIWCxVQUFLLEdBQUcsS0FBSyxDQUFDOzs7Ozs7K0NBbEJGLFlBQVk7Ozs7UUF1QjlCLElBQUksS0FBSyxDQUFDLEtBQUssWUFBWSxxQkFBUyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7WUFDbEUsS0FBSyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQztRQUVELElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsS0FBSyxDQUFDLEtBQUssNkhBQTZILENBQUMsQ0FBQztTQUN4SztRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFFdEQsY0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUMvRDtJQUVEOzs7Ozs7T0FNRztJQUNJLFFBQVEsQ0FBQyxLQUFZLEVBQUUsT0FBc0I7Ozs7Ozs7Ozs7UUFDbEQsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQywyRUFBMkUsQ0FBQyxDQUFDO1NBQzlGO1FBQ0QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQy9EO0lBRUQ7Ozs7Ozs7Ozs7Ozs7O09BY0c7SUFDSSxPQUFPLENBQUMsRUFBVSxFQUFFLE9BQXFCOzs7Ozs7Ozs7O1FBQzlDLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMseUVBQXlFLENBQUMsQ0FBQztTQUM1RjtRQUVELE1BQU0sSUFBSSxHQUFHLElBQUksZ0JBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEIsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVEOzs7O09BSUc7SUFDSSxhQUFhO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztTQUMzRTtRQUNELElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztLQUNuQjtJQU9EOztPQUVHO0lBQ0ssZUFBZTtRQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNmLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjtLQUNGOztBQXRHSCxvQ0F1R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3BlY3RzLCBTdGFnZSB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBBZGRTdGFnZU9wdHMgYXMgU3RhZ2VPcHRpb25zLCBXYXZlT3B0aW9ucywgV2F2ZSwgSUZpbGVTZXRQcm9kdWNlciwgU2hlbGxTdGVwLCBGaWxlU2V0IH0gZnJvbSAnLi4vYmx1ZXByaW50JztcblxuLy8gdjIgLSBrZWVwIHRoaXMgaW1wb3J0IGFzIGEgc2VwYXJhdGUgc2VjdGlvbiB0byByZWR1Y2UgbWVyZ2UgY29uZmxpY3Qgd2hlbiBmb3J3YXJkIG1lcmdpbmcgd2l0aCB0aGUgdjIgYnJhbmNoLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG5pbXBvcnQgeyBDb25zdHJ1Y3QgYXMgQ29yZUNvbnN0cnVjdCB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGEgYFBpcGVsaW5lYFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFBpcGVsaW5lQmFzZVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBidWlsZCBzdGVwIHRoYXQgcHJvZHVjZXMgdGhlIENESyBDbG91ZCBBc3NlbWJseVxuICAgKlxuICAgKiBUaGUgcHJpbWFyeSBvdXRwdXQgb2YgdGhpcyBzdGVwIG5lZWRzIHRvIGJlIHRoZSBgY2RrLm91dGAgZGlyZWN0b3J5XG4gICAqIGdlbmVyYXRlZCBieSB0aGUgYGNkayBzeW50aGAgY29tbWFuZC5cbiAgICpcbiAgICogSWYgeW91IHVzZSBhIGBTaGVsbFN0ZXBgIGhlcmUgYW5kIHlvdSBkb24ndCBjb25maWd1cmUgYW4gb3V0cHV0IGRpcmVjdG9yeSxcbiAgICogdGhlIG91dHB1dCBkaXJlY3Rvcnkgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGFzc3VtZWQgdG8gYmUgYGNkay5vdXRgLlxuICAgKi9cbiAgcmVhZG9ubHkgc3ludGg6IElGaWxlU2V0UHJvZHVjZXI7XG59XG5cbi8qKlxuICogQSBnZW5lcmljIENESyBQaXBlbGluZXMgcGlwZWxpbmVcbiAqXG4gKiBEaWZmZXJlbnQgZGVwbG95bWVudCBzeXN0ZW1zIHdpbGwgcHJvdmlkZSBzdWJjbGFzc2VzIG9mIGBQaXBlbGluZWAgdGhhdCBnZW5lcmF0ZVxuICogdGhlIGRlcGxveW1lbnQgaW5mcmFzdHJ1Y3R1cmUgbmVjZXNzYXJ5IHRvIGRlcGxveSBDREsgYXBwcywgc3BlY2lmaWMgdG8gdGhhdCBzeXN0ZW0uXG4gKlxuICogVGhpcyBsaWJyYXJ5IGNvbWVzIHdpdGggdGhlIGBDb2RlUGlwZWxpbmVgIGNsYXNzLCB3aGljaCB1c2VzIEFXUyBDb2RlUGlwZWxpbmVcbiAqIHRvIGRlcGxveSBDREsgYXBwcy5cbiAqXG4gKiBUaGUgYWN0dWFsIHBpcGVsaW5lIGluZnJhc3RydWN0dXJlIGlzIGNvbnN0cnVjdGVkIChieSBpbnZva2luZyB0aGUgZW5naW5lKVxuICogd2hlbiBgYnVpbGRQaXBlbGluZSgpYCBpcyBjYWxsZWQsIG9yIHdoZW4gYGFwcC5zeW50aCgpYCBpcyBjYWxsZWQgKHdoaWNoZXZlclxuICogaGFwcGVucyBmaXJzdCkuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQaXBlbGluZUJhc2UgZXh0ZW5kcyBDb3JlQ29uc3RydWN0IHtcbiAgLyoqXG4gICAqIFRoZSBidWlsZCBzdGVwIHRoYXQgcHJvZHVjZXMgdGhlIENESyBDbG91ZCBBc3NlbWJseVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHN5bnRoOiBJRmlsZVNldFByb2R1Y2VyO1xuXG4gIC8qKlxuICAgKiBUaGUgd2F2ZXMgaW4gdGhpcyBwaXBlbGluZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHdhdmVzOiBXYXZlW107XG5cbiAgLyoqXG4gICAqIFRoZSBGaWxlU2V0IHRoYSBjb250YWlucyB0aGUgY2xvdWQgYXNzZW1ibHlcbiAgICpcbiAgICogVGhpcyBpcyB0aGUgcHJpbWFyeSBvdXRwdXQgb2YgdGhlIHN5bnRoIHN0ZXAuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY2xvdWRBc3NlbWJseUZpbGVTZXQ6IEZpbGVTZXQ7XG5cbiAgcHJpdmF0ZSBidWlsdCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBQaXBlbGluZUJhc2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBpZiAocHJvcHMuc3ludGggaW5zdGFuY2VvZiBTaGVsbFN0ZXAgJiYgIXByb3BzLnN5bnRoLnByaW1hcnlPdXRwdXQpIHtcbiAgICAgIHByb3BzLnN5bnRoLnByaW1hcnlPdXRwdXREaXJlY3RvcnkoJ2Nkay5vdXQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3BzLnN5bnRoLnByaW1hcnlPdXRwdXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgc3ludGhTdGVwICR7cHJvcHMuc3ludGh9IG11c3QgcHJvZHVjZSBhIHByaW1hcnkgb3V0cHV0LCBidXQgaXMgbm90IHByb2R1Y2luZyBhbnl0aGluZy4gQ29uZmlndXJlIHRoZSBTdGVwIGRpZmZlcmVudGx5IG9yIHVzZSBhIGRpZmZlcmVudCBTdGVwIHR5cGUuYCk7XG4gICAgfVxuXG4gICAgdGhpcy5zeW50aCA9IHByb3BzLnN5bnRoO1xuICAgIHRoaXMud2F2ZXMgPSBbXTtcbiAgICB0aGlzLmNsb3VkQXNzZW1ibHlGaWxlU2V0ID0gcHJvcHMuc3ludGgucHJpbWFyeU91dHB1dDtcblxuICAgIEFzcGVjdHMub2YodGhpcykuYWRkKHsgdmlzaXQ6ICgpID0+IHRoaXMuYnVpbGRKdXN0SW5UaW1lKCkgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVwbG95IGEgc2luZ2xlIFN0YWdlIGJ5IGl0c2VsZlxuICAgKlxuICAgKiBBZGQgYSBTdGFnZSB0byB0aGUgcGlwZWxpbmUsIHRvIGJlIGRlcGxveWVkIGluIHNlcXVlbmNlIHdpdGggb3RoZXJcbiAgICogU3RhZ2VzIGFkZGVkIHRvIHRoZSBwaXBlbGluZS4gQWxsIFN0YWNrcyBpbiB0aGUgc3RhZ2Ugd2lsbCBiZSBkZXBsb3llZFxuICAgKiBpbiBhbiBvcmRlciBhdXRvbWF0aWNhbGx5IGRldGVybWluZWQgYnkgdGhlaXIgcmVsYXRpdmUgZGVwZW5kZW5jaWVzLlxuICAgKi9cbiAgcHVibGljIGFkZFN0YWdlKHN0YWdlOiBTdGFnZSwgb3B0aW9ucz86IFN0YWdlT3B0aW9ucykge1xuICAgIGlmICh0aGlzLmJ1aWx0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FkZFN0YWdlOiBjYW5cXCd0IGFkZCBTdGFnZXMgYW55bW9yZSBhZnRlciBidWlsZFBpcGVsaW5lKCkgaGFzIGJlZW4gY2FsbGVkJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmFkZFdhdmUoc3RhZ2Uuc3RhZ2VOYW1lKS5hZGRTdGFnZShzdGFnZSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgV2F2ZSB0byB0aGUgcGlwZWxpbmUsIGZvciBkZXBsb3lpbmcgbXVsdGlwbGUgU3RhZ2VzIGluIHBhcmFsbGVsXG4gICAqXG4gICAqIFVzZSB0aGUgcmV0dXJuIG9iamVjdCBvZiB0aGlzIG1ldGhvZCB0byBkZXBsb3kgbXVsdGlwbGUgc3RhZ2VzIGluIHBhcmFsbGVsLlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBkZWNsYXJlIGNvbnN0IHBpcGVsaW5lOiBwaXBlbGluZXMuQ29kZVBpcGVsaW5lO1xuICAgKlxuICAgKiBjb25zdCB3YXZlID0gcGlwZWxpbmUuYWRkV2F2ZSgnTXlXYXZlJyk7XG4gICAqIHdhdmUuYWRkU3RhZ2UobmV3IE15QXBwbGljYXRpb25TdGFnZSh0aGlzLCAnU3RhZ2UxJykpO1xuICAgKiB3YXZlLmFkZFN0YWdlKG5ldyBNeUFwcGxpY2F0aW9uU3RhZ2UodGhpcywgJ1N0YWdlMicpKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkV2F2ZShpZDogc3RyaW5nLCBvcHRpb25zPzogV2F2ZU9wdGlvbnMpIHtcbiAgICBpZiAodGhpcy5idWlsdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdhZGRXYXZlOiBjYW5cXCd0IGFkZCBXYXZlcyBhbnltb3JlIGFmdGVyIGJ1aWxkUGlwZWxpbmUoKSBoYXMgYmVlbiBjYWxsZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCB3YXZlID0gbmV3IFdhdmUoaWQsIG9wdGlvbnMpO1xuICAgIHRoaXMud2F2ZXMucHVzaCh3YXZlKTtcbiAgICByZXR1cm4gd2F2ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kIHRoZSBjdXJyZW50IHBpcGVsaW5lIGRlZmluaXRpb24gdG8gdGhlIGVuZ2luZSwgYW5kIGNvbnN0cnVjdCB0aGUgcGlwZWxpbmVcbiAgICpcbiAgICogSXQgaXMgbm90IHBvc3NpYmxlIHRvIG1vZGlmeSB0aGUgcGlwZWxpbmUgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZC5cbiAgICovXG4gIHB1YmxpYyBidWlsZFBpcGVsaW5lKCkge1xuICAgIGlmICh0aGlzLmJ1aWx0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1aWxkKCkgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQ6IGNhbiBvbmx5IGNhbGwgaXQgb25jZScpO1xuICAgIH1cbiAgICB0aGlzLmRvQnVpbGRQaXBlbGluZSgpO1xuICAgIHRoaXMuYnVpbHQgPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMgdG8gZG8gdGhlIGFjdHVhbCBwaXBlbGluZSBjb25zdHJ1Y3Rpb25cbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBkb0J1aWxkUGlwZWxpbmUoKTogdm9pZDtcblxuICAvKipcbiAgICogQXV0b21hdGljYWxseSBjYWxsICdidWlsZCgpJyBqdXN0IGJlZm9yZSBzeW50aGVzaXMgaWYgdGhlIHVzZXIgaGFzbid0IGV4cGxpY2l0bHkgY2FsbGVkIGl0IHlldFxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZEp1c3RJblRpbWUoKSB7XG4gICAgaWYgKCF0aGlzLmJ1aWx0KSB7XG4gICAgICB0aGlzLmJ1aWxkUGlwZWxpbmUoKTtcbiAgICB9XG4gIH1cbn0iXX0=