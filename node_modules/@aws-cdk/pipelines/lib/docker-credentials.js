"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.dockerCredentialsInstallCommands = exports.DockerCredentialUsage = exports.DockerCredential = void 0;
const jsiiDeprecationWarnings = require("../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const ec2 = require("@aws-cdk/aws-ec2");
const iam = require("@aws-cdk/aws-iam");
const core_1 = require("@aws-cdk/core");
/**
 * Represents credentials used to access a Docker registry.
 */
class DockerCredential {
    constructor(usages) {
        this.usages = usages;
    }
    /**
     * Creates a DockerCredential for DockerHub.
     * Convenience method for `customRegistry('https://index.docker.io/v1/', opts)`.
     */
    static dockerHub(secret, opts = {}) {
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_ExternalDockerCredentialOptions(opts);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.dockerHub);
            }
            throw error;
        }
        return new ExternalDockerCredential('https://index.docker.io/v1/', secret, opts);
    }
    /**
     * Creates a DockerCredential for a registry, based on its domain name (e.g., 'www.example.com').
     */
    static customRegistry(registryDomain, secret, opts = {}) {
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_ExternalDockerCredentialOptions(opts);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.customRegistry);
            }
            throw error;
        }
        return new ExternalDockerCredential(registryDomain, secret, opts);
    }
    /**
     * Creates a DockerCredential for one or more ECR repositories.
     *
     * NOTE - All ECR repositories in the same account and region share a domain name
     * (e.g., 0123456789012.dkr.ecr.eu-west-1.amazonaws.com), and can only have one associated
     * set of credentials (and DockerCredential). Attempting to associate one set of credentials
     * with one ECR repo and another with another ECR repo in the same account and region will
     * result in failures when using these credentials in the pipeline.
     */
    static ecr(repositories, opts) {
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_EcrDockerCredentialOptions(opts);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.ecr);
            }
            throw error;
        }
        return new EcrDockerCredential(repositories, opts ?? {});
    }
    /**
     * Determines if this credential is relevant to the input usage.
     * @internal
     */
    _applicableForUsage(usage) {
        return !this.usages || this.usages.includes(usage);
    }
}
exports.DockerCredential = DockerCredential;
_a = JSII_RTTI_SYMBOL_1;
DockerCredential[_a] = { fqn: "@aws-cdk/pipelines.DockerCredential", version: "1.204.0" };
/** Defines which stages of a pipeline require the specified credentials */
var DockerCredentialUsage;
(function (DockerCredentialUsage) {
    /** Synth/Build */
    DockerCredentialUsage["SYNTH"] = "SYNTH";
    /** Self-update */
    DockerCredentialUsage["SELF_UPDATE"] = "SELF_UPDATE";
    /** Asset publishing */
    DockerCredentialUsage["ASSET_PUBLISHING"] = "ASSET_PUBLISHING";
})(DockerCredentialUsage = exports.DockerCredentialUsage || (exports.DockerCredentialUsage = {}));
;
/** DockerCredential defined by registry domain and a secret */
class ExternalDockerCredential extends DockerCredential {
    constructor(registryDomain, secret, opts) {
        super(opts.usages);
        this.registryDomain = registryDomain;
        this.secret = secret;
        this.opts = opts;
    }
    grantRead(grantee, usage) {
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = this.opts.assumeRole ?? grantee;
        this.secret.grantRead(role);
    }
    _renderCdkAssetsConfig() {
        return {
            [this.registryDomain]: {
                secretsManagerSecretId: this.secret.secretArn,
                secretsUsernameField: this.opts.secretUsernameField,
                secretsPasswordField: this.opts.secretPasswordField,
                assumeRoleArn: this.opts.assumeRole?.roleArn,
            },
        };
    }
}
/** DockerCredential defined by a set of ECR repositories in the same account & region */
class EcrDockerCredential extends DockerCredential {
    constructor(repositories, opts) {
        super(opts.usages);
        this.repositories = repositories;
        this.opts = opts;
        if (repositories.length === 0) {
            throw new Error('must supply at least one `ecr.IRepository` to create an `EcrDockerCredential`');
        }
        this.registryDomain = core_1.Fn.select(0, core_1.Fn.split('/', repositories[0].repositoryUri));
    }
    grantRead(grantee, usage) {
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = this.opts.assumeRole ?? grantee;
        this.repositories.forEach(repo => repo.grantPull(role));
    }
    _renderCdkAssetsConfig() {
        return {
            [this.registryDomain]: {
                ecrRepository: true,
                assumeRoleArn: this.opts.assumeRole?.roleArn,
            },
        };
    }
}
/**
 * Creates a set of OS-specific buildspec installation commands for setting up the given
 * registries and associated credentials.
 *
 * @param registries - Registries to configure credentials for. It is an error to provide
 * multiple registries for the same domain.
 * @param osType - (optional) Defaults to Linux.
 * @returns An array of commands to configure cdk-assets to use these credentials.
 */
function dockerCredentialsInstallCommands(usage, registries, osType) {
    const relevantRegistries = (registries ?? []).filter(reg => reg._applicableForUsage(usage));
    if (!relevantRegistries || relevantRegistries.length === 0) {
        return [];
    }
    const domainCredentials = relevantRegistries.reduce(function (map, registry) {
        Object.assign(map, registry._renderCdkAssetsConfig());
        return map;
    }, {});
    const cdkAssetsConfigFile = {
        version: '1.0',
        domainCredentials,
    };
    const windowsCommands = [
        'mkdir %USERPROFILE%\\.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > %USERPROFILE%\\.cdk\\cdk-docker-creds.json`,
    ];
    const linuxCommands = [
        'mkdir $HOME/.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > $HOME/.cdk/cdk-docker-creds.json`,
    ];
    if (osType === 'both') {
        return [
            // These tags are magic and will be stripped when rendering the project
            ...windowsCommands.map(c => `!WINDOWS!${c}`),
            ...linuxCommands.map(c => `!LINUX!${c}`),
        ];
    }
    else if (osType === ec2.OperatingSystemType.WINDOWS) {
        return windowsCommands;
    }
    else {
        return linuxCommands;
    }
}
exports.dockerCredentialsInstallCommands = dockerCredentialsInstallCommands;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLWNyZWRlbnRpYWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLWNyZWRlbnRpYWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHdDQUF3QztBQUV4Qyx3Q0FBd0M7QUFFeEMsd0NBQW1DO0FBRW5DOztHQUVHO0FBQ0gsTUFBc0IsZ0JBQWdCO0lBZ0NwQyxZQUErQixNQUFnQztRQUFoQyxXQUFNLEdBQU4sTUFBTSxDQUEwQjtLQUFLO0lBL0JwRTs7O09BR0c7SUFDSSxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQThCLEVBQUUsT0FBd0MsRUFBRTs7Ozs7Ozs7OztRQUNoRyxPQUFPLElBQUksd0JBQXdCLENBQUMsNkJBQTZCLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ2xGO0lBRUQ7O09BRUc7SUFDSSxNQUFNLENBQUMsY0FBYyxDQUMxQixjQUFzQixFQUN0QixNQUE4QixFQUM5QixPQUF3QyxFQUFFOzs7Ozs7Ozs7O1FBQzFDLE9BQU8sSUFBSSx3QkFBd0IsQ0FBQyxjQUFjLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ25FO0lBRUQ7Ozs7Ozs7O09BUUc7SUFDSSxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQStCLEVBQUUsSUFBaUM7Ozs7Ozs7Ozs7UUFDbEYsT0FBTyxJQUFJLG1CQUFtQixDQUFDLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7S0FDMUQ7SUFJRDs7O09BR0c7SUFDSSxtQkFBbUIsQ0FBQyxLQUE0QjtRQUNyRCxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUNwRDs7QUF4Q0gsNENBc0RDOzs7QUF3Q0QsMkVBQTJFO0FBQzNFLElBQVkscUJBT1g7QUFQRCxXQUFZLHFCQUFxQjtJQUMvQixrQkFBa0I7SUFDbEIsd0NBQWUsQ0FBQTtJQUNmLGtCQUFrQjtJ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QUFDO0lBRUYsTUFBTSxhQUFhLEdBQUc7UUFDcEIsa0JBQWtCO1FBQ2xCLFNBQVMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxzQ0FBc0M7S0FDbkYsQ0FBQztJQUVGLElBQUksTUFBTSxLQUFLLE1BQU0sRUFBRTtRQUNyQixPQUFPO1lBQ0wsdUVBQXVFO1lBQ3ZFLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7WUFDNUMsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztTQUN6QyxDQUFDO0tBQ0g7U0FBTSxJQUFJLE1BQU0sS0FBSyxHQUFHLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFO1FBQ3JELE9BQU8sZUFBZSxDQUFDO0tBQ3hCO1NBQU07UUFDTCxPQUFPLGFBQWEsQ0FBQztLQUN0QjtBQUNILENBQUM7QUF0Q0QsNEVBc0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZWMyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgZWNyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lY3InO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSAnQGF3cy1jZGsvYXdzLXNlY3JldHNtYW5hZ2VyJztcbmltcG9ydCB7IEZuIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5cbi8qKlxuICogUmVwcmVzZW50cyBjcmVkZW50aWFscyB1c2VkIHRvIGFjY2VzcyBhIERvY2tlciByZWdpc3RyeS5cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIERvY2tlckNyZWRlbnRpYWwge1xuICAvKipcbiAgICogQ3JlYXRlcyBhIERvY2tlckNyZWRlbnRpYWwgZm9yIERvY2tlckh1Yi5cbiAgICogQ29udmVuaWVuY2UgbWV0aG9kIGZvciBgY3VzdG9tUmVnaXN0cnkoJ2h0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLycsIG9wdHMpYC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZG9ja2VySHViKHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCwgb3B0czogRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsT3B0aW9ucyA9IHt9KTogRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgcmV0dXJuIG5ldyBFeHRlcm5hbERvY2tlckNyZWRlbnRpYWwoJ2h0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLycsIHNlY3JldCwgb3B0cyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIERvY2tlckNyZWRlbnRpYWwgZm9yIGEgcmVnaXN0cnksIGJhc2VkIG9uIGl0cyBkb21haW4gbmFtZSAoZS5nLiwgJ3d3dy5leGFtcGxlLmNvbScpLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjdXN0b21SZWdpc3RyeShcbiAgICByZWdpc3RyeURvbWFpbjogc3RyaW5nLFxuICAgIHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCxcbiAgICBvcHRzOiBFeHRlcm5hbERvY2tlckNyZWRlbnRpYWxPcHRpb25zID0ge30pOiBEb2NrZXJDcmVkZW50aWFsIHtcbiAgICByZXR1cm4gbmV3IEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbChyZWdpc3RyeURvbWFpbiwgc2VjcmV0LCBvcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgRG9ja2VyQ3JlZGVudGlhbCBmb3Igb25lIG9yIG1vcmUgRUNSIHJlcG9zaXRvcmllcy5cbiAgICpcbiAgICogTk9URSAtIEFsbCBFQ1IgcmVwb3NpdG9yaWVzIGluIHRoZSBzYW1lIGFjY291bnQgYW5kIHJlZ2lvbiBzaGFyZSBhIGRvbWFpbiBuYW1lXG4gICAqIChlLmcuLCAwMTIzNDU2Nzg5MDEyLmRrci5lY3IuZXUtd2VzdC0xLmFtYXpvbmF3cy5jb20pLCBhbmQgY2FuIG9ubHkgaGF2ZSBvbmUgYXNzb2NpYXRlZFxuICAgKiBzZXQgb2YgY3JlZGVudGlhbHMgKGFuZCBEb2NrZXJDcmVkZW50aWFsKS4gQXR0ZW1wdGluZyB0byBhc3NvY2lhdGUgb25lIHNldCBvZiBjcmVkZW50aWFsc1xuICAgKiB3aXRoIG9uZSBFQ1IgcmVwbyBhbmQgYW5vdGhlciB3aXRoIGFub3RoZXIgRUNSIHJlcG8gaW4gdGhlIHNhbWUgYWNjb3VudCBhbmQgcmVnaW9uIHdpbGxcbiAgICogcmVzdWx0IGluIGZhaWx1cmVzIHdoZW4gdXNpbmcgdGhlc2UgY3JlZGVudGlhbHMgaW4gdGhlIHBpcGVsaW5lLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBlY3IocmVwb3NpdG9yaWVzOiBlY3IuSVJlcG9zaXRvcnlbXSwgb3B0cz86IEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zKTogRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgcmV0dXJuIG5ldyBFY3JEb2NrZXJDcmVkZW50aWFsKHJlcG9zaXRvcmllcywgb3B0cyA/PyB7fSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW10pIHsgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIHRoaXMgY3JlZGVudGlhbCBpcyByZWxldmFudCB0byB0aGUgaW5wdXQgdXNhZ2UuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2U6IERvY2tlckNyZWRlbnRpYWxVc2FnZSkge1xuICAgIHJldHVybiAhdGhpcy51c2FnZXMgfHwgdGhpcy51c2FnZXMuaW5jbHVkZXModXNhZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdyYW50IHJlYWQtb25seSBhY2Nlc3MgdG8gdGhlIHJlZ2lzdHJ5IGNyZWRlbnRpYWxzLlxuICAgKiBUaGlzIGdyYW50cyByZWFkIGFjY2VzcyB0byBhbnkgc2VjcmV0cywgYW5kIHB1bGwgYWNjZXNzIHRvIGFueSByZXBvc2l0b3JpZXMuXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKTogdm9pZDtcblxuICAvKipcbiAgICogQ3JlYXRlcyBhbmQgcmV0dXJucyB0aGUgY3JlZGVudGlhbCBjb25maWd1cmF0aW9uLCB0byBiZSB1c2VkIGJ5IGBjZGstYXNzZXRzYFxuICAgKiB0byBzdXBwb3J0IHRoZSBgZG9ja2VyLWNyZWRlbnRpYWwtY2RrLWFzc2V0c2AgdG9vbCBmb3IgYGRvY2tlciBsb2dpbmAuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IF9yZW5kZXJDZGtBc3NldHNDb25maWcoKTogRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Vcbn1cblxuLyoqIE9wdGlvbnMgZm9yIGRlZmluaW5nIGNyZWRlbnRpYWxzIGZvciBhIERvY2tlciBDcmVkZW50aWFsICovXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIEpTT04gZmllbGQgb2YgdGhlIHNlY3JldCB3aGljaCBjb250YWlucyB0aGUgdXNlci9sb2dpbiBuYW1lLlxuICAgKiBAZGVmYXVsdCAndXNlcm5hbWUnXG4gICAqL1xuICByZWFkb25seSBzZWNyZXRVc2VybmFtZUZpZWxkPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIEpTT04gZmllbGQgb2YgdGhlIHNlY3JldCB3aGljaCBjb250YWlucyB0aGUgc2VjcmV0L3Bhc3N3b3JkLlxuICAgKiBAZGVmYXVsdCAnc2VjcmV0J1xuICAgKi9cbiAgcmVhZG9ubHkgc2VjcmV0UGFzc3dvcmRGaWVsZD86IHN0cmluZztcbiAgLyoqXG4gICAqIEFuIElBTSByb2xlIHRvIGFzc3VtZSBwcmlvciB0byBhY2Nlc3NpbmcgdGhlIHNlY3JldC5cbiAgICogQGRlZmF1bHQgLSBub25lLiBUaGUgY3VycmVudCBleGVjdXRpb24gcm9sZSB3aWxsIGJlIHVzZWQuXG4gICAqL1xuICByZWFkb25seSBhc3N1bWVSb2xlPzogaWFtLklSb2xlXG4gIC8qKlxuICAgKiBEZWZpbmVzIHdoaWNoIHN0YWdlcyBvZiB0aGUgcGlwZWxpbmUgc2hvdWxkIGJlIGdyYW50ZWQgYWNjZXNzIHRvIHRoZXNlIGNyZWRlbnRpYWxzLlxuICAgKiBAZGVmYXVsdCAtIGFsbCByZWxldmFudCBzdGFnZXMgKHN5bnRoLCBzZWxmLXVwZGF0ZSwgYXNzZXQgcHVibGlzaGluZykgYXJlIGdyYW50ZWQgYWNjZXNzLlxuICAgKi9cbiAgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW107XG59XG5cbi8qKiBPcHRpb25zIGZvciBkZWZpbmluZyBhY2Nlc3MgZm9yIGEgRG9ja2VyIENyZWRlbnRpYWwgY29tcG9zZWQgb2YgRUNSIHJlcG9zICovXG5leHBvcnQgaW50ZXJmYWNlIEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zIHtcbiAgLyoqXG4gICAqIEFuIElBTSByb2xlIHRvIGFzc3VtZSBwcmlvciB0byBhY2Nlc3NpbmcgdGhlIHNlY3JldC5cbiAgICogQGRlZmF1bHQgLSBub25lLiBUaGUgY3VycmVudCBleGVjdXRpb24gcm9sZSB3aWxsIGJlIHVzZWQuXG4gICAqL1xuICByZWFkb25seSBhc3N1bWVSb2xlPzogaWFtLklSb2xlXG4gIC8qKlxuICAgKiBEZWZpbmVzIHdoaWNoIHN0YWdlcyBvZiB0aGUgcGlwZWxpbmUgc2hvdWxkIGJlIGdyYW50ZWQgYWNjZXNzIHRvIHRoZXNlIGNyZWRlbnRpYWxzLlxuICAgKiBAZGVmYXVsdCAtIGFsbCByZWxldmFudCBzdGFnZXMgKHN5bnRoLCBzZWxmLXVwZGF0ZSwgYXNzZXQgcHVibGlzaGluZykgYXJlIGdyYW50ZWQgYWNjZXNzLlxuICAgKi9cbiAgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW107XG59XG5cbi8qKiBEZWZpbmVzIHdoaWNoIHN0YWdlcyBvZiBhIHBpcGVsaW5lIHJlcXVpcmUgdGhlIHNwZWNpZmllZCBjcmVkZW50aWFscyAqL1xuZXhwb3J0IGVudW0gRG9ja2VyQ3JlZGVudGlhbFVzYWdlIHtcbiAgLyoqIFN5bnRoL0J1aWxkICovXG4gIFNZTlRIID0gJ1NZTlRIJyxcbiAgLyoqIFNlbGYtdXBkYXRlICovXG4gIFNFTEZfVVBEQVRFID0gJ1NFTEZfVVBEQVRFJyxcbiAgLyoqIEFzc2V0IHB1Ymxpc2hpbmcgKi9cbiAgQVNTRVRfUFVCTElTSElORyA9ICdBU1NFVF9QVUJMSVNISU5HJyxcbn07XG5cbi8qKiBEb2NrZXJDcmVkZW50aWFsIGRlZmluZWQgYnkgcmVnaXN0cnkgZG9tYWluIGFuZCBhIHNlY3JldCAqL1xuY2xhc3MgRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsIGV4dGVuZHMgRG9ja2VyQ3JlZGVudGlhbCB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVnaXN0cnlEb21haW46IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdHM6IEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRzLnVzYWdlcyk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKSB7XG4gICAgaWYgKCF0aGlzLl9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2UpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5hc3N1bWVSb2xlKSB7XG4gICAgICBncmFudGVlLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLm9wdHMuYXNzdW1lUm9sZS5yb2xlQXJuXSxcbiAgICAgIH0pKTtcbiAgICB9XG4gICAgY29uc3Qgcm9sZSA9IHRoaXMub3B0cy5hc3N1bWVSb2xlID8/IGdyYW50ZWU7XG4gICAgdGhpcy5zZWNyZXQuZ3JhbnRSZWFkKHJvbGUpO1xuICB9XG5cbiAgcHVibGljIF9yZW5kZXJDZGtBc3NldHNDb25maWcoKTogRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Uge1xuICAgIHJldHVybiB7XG4gICAgICBbdGhpcy5yZWdpc3RyeURvbWFpbl06IHtcbiAgICAgICAgc2VjcmV0c01hbmFnZXJTZWNyZXRJZDogdGhpcy5zZWNyZXQuc2VjcmV0QXJuLFxuICAgICAgICBzZWNyZXRzVXNlcm5hbWVGaWVsZDogdGhpcy5vcHRzLnNlY3JldFVzZXJuYW1lRmllbGQsXG4gICAgICAgIHNlY3JldHNQYXNzd29yZEZpZWxkOiB0aGlzLm9wdHMuc2VjcmV0UGFzc3dvcmRGaWVsZCxcbiAgICAgICAgYXNzdW1lUm9sZUFybjogdGhpcy5vcHRzLmFzc3VtZVJvbGU/LnJvbGVBcm4sXG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqIERvY2tlckNyZWRlbnRpYWwgZGVmaW5lZCBieSBhIHNldCBvZiBFQ1IgcmVwb3NpdG9yaWVzIGluIHRoZSBzYW1lIGFjY291bnQgJiByZWdpb24gKi9cbmNsYXNzIEVjckRvY2tlckNyZWRlbnRpYWwgZXh0ZW5kcyBEb2NrZXJDcmVkZW50aWFsIHtcbiAgcHVibGljIHJlYWRvbmx5IHJlZ2lzdHJ5RG9tYWluOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSByZXBvc2l0b3JpZXM6IGVjci5JUmVwb3NpdG9yeVtdLCBwcml2YXRlIHJlYWRvbmx5IG9wdHM6IEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zKSB7XG4gICAgc3VwZXIob3B0cy51c2FnZXMpO1xuXG4gICAgaWYgKHJlcG9zaXRvcmllcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBzdXBwbHkgYXQgbGVhc3Qgb25lIGBlY3IuSVJlcG9zaXRvcnlgIHRvIGNyZWF0ZSBhbiBgRWNyRG9ja2VyQ3JlZGVudGlhbGAnKTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RyeURvbWFpbiA9IEZuLnNlbGVjdCgwLCBGbi5zcGxpdCgnLycsIHJlcG9zaXRvcmllc1swXS5yZXBvc2l0b3J5VXJpKSk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKSB7XG4gICAgaWYgKCF0aGlzLl9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2UpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5hc3N1bWVSb2xlKSB7XG4gICAgICBncmFudGVlLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLm9wdHMuYXNzdW1lUm9sZS5yb2xlQXJuXSxcbiAgICAgIH0pKTtcbiAgICB9XG4gICAgY29uc3Qgcm9sZSA9IHRoaXMub3B0cy5hc3N1bWVSb2xlID8/IGdyYW50ZWU7XG4gICAgdGhpcy5yZXBvc2l0b3JpZXMuZm9yRWFjaChyZXBvID0+IHJlcG8uZ3JhbnRQdWxsKHJvbGUpKTtcbiAgfVxuXG4gIHB1YmxpYyBfcmVuZGVyQ2RrQXNzZXRzQ29uZmlnKCk6IERvY2tlckNyZWRlbnRpYWxDcmVkZW50aWFsU291cmNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgW3RoaXMucmVnaXN0cnlEb21haW5dOiB7XG4gICAgICAgIGVjclJlcG9zaXRvcnk6IHRydWUsXG4gICAgICAgIGFzc3VtZVJvbGVBcm46IHRoaXMub3B0cy5hc3N1bWVSb2xlPy5yb2xlQXJuLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG5cbi8qKiBGb3JtYXQgZm9yIHRoZSBDREsgYXNzZXRzIGNvbmZpZy4gU2VlIHRoZSBjZGstYXNzZXRzIGBEb2NrZXJEb21haW5DcmVkZW50aWFsU291cmNlYCAqL1xuaW50ZXJmYWNlIERvY2tlckNyZWRlbnRpYWxDcmVkZW50aWFsU291cmNlIHtcbiAgcmVhZG9ubHkgc2VjcmV0c01hbmFnZXJTZWNyZXRJZD86IHN0cmluZztcbiAgcmVhZG9ubHkgc2VjcmV0c1VzZXJuYW1lRmllbGQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNlY3JldHNQYXNzd29yZEZpZWxkPzogc3RyaW5nO1xuICByZWFkb25seSBlY3JSZXBvc2l0b3J5PzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYXNzdW1lUm9sZUFybj86IHN0cmluZztcbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgc2V0IG9mIE9TLXNwZWNpZmljIGJ1aWxkc3BlYyBpbnN0YWxsYXRpb24gY29tbWFuZHMgZm9yIHNldHRpbmcgdXAgdGhlIGdpdmVuXG4gKiByZWdpc3RyaWVzIGFuZCBhc3NvY2lhdGVkIGNyZWRlbnRpYWxzLlxuICpcbiAqIEBwYXJhbSByZWdpc3RyaWVzIC0gUmVnaXN0cmllcyB0byBjb25maWd1cmUgY3JlZGVudGlhbHMgZm9yLiBJdCBpcyBhbiBlcnJvciB0byBwcm92aWRlXG4gKiBtdWx0aXBsZSByZWdpc3RyaWVzIGZvciB0aGUgc2FtZSBkb21haW4uXG4gKiBAcGFyYW0gb3NUeXBlIC0gKG9wdGlvbmFsKSBEZWZhdWx0cyB0byBMaW51eC5cbiAqIEByZXR1cm5zIEFuIGFycmF5IG9mIGNvbW1hbmRzIHRvIGNvbmZpZ3VyZSBjZGstYXNzZXRzIHRvIHVzZSB0aGVzZSBjcmVkZW50aWFscy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRvY2tlckNyZWRlbnRpYWxzSW5zdGFsbENvbW1hbmRzKFxuICB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlLFxuICByZWdpc3RyaWVzPzogRG9ja2VyQ3JlZGVudGlhbFtdLFxuICBvc1R5cGU/OiBlYzIuT3BlcmF0aW5nU3lzdGVtVHlwZSB8ICdib3RoJyk6IHN0cmluZ1tdIHtcblxuICBjb25zdCByZWxldmFudFJlZ2lzdHJpZXMgPSAocmVnaXN0cmllcyA/PyBbXSkuZmlsdGVyKHJlZyA9PiByZWcuX2FwcGxpY2FibGVGb3JVc2FnZSh1c2FnZSkpO1xuICBpZiAoIXJlbGV2YW50UmVnaXN0cmllcyB8fCByZWxldmFudFJlZ2lzdHJpZXMubGVuZ3RoID09PSAwKSB7IHJldHVybiBbXTsgfVxuXG4gIGNvbnN0IGRvbWFpbkNyZWRlbnRpYWxzID0gcmVsZXZhbnRSZWdpc3RyaWVzLnJlZHVjZShmdW5jdGlvbiAobWFwOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCByZWdpc3RyeSkge1xuICAgIE9iamVjdC5hc3NpZ24obWFwLCByZWdpc3RyeS5fcmVuZGVyQ2RrQXNzZXRzQ29uZmlnKCkpO1xuICAgIHJldHVybiBtYXA7XG4gIH0sIHt9KTtcbiAgY29uc3QgY2RrQXNzZXRzQ29uZmlnRmlsZSA9IHtcbiAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICBkb21haW5DcmVkZW50aWFscyxcbiAgfTtcblxuICBjb25zdCB3aW5kb3dzQ29tbWFuZHMgPSBbXG4gICAgJ21rZGlyICVVU0VSUFJPRklMRSVcXFxcLmNkaycsXG4gICAgYGVjaG8gJyR7SlNPTi5zdHJpbmdpZnkoY2RrQXNzZXRzQ29uZmlnRmlsZSl9JyA+ICVVU0VSUFJPRklMRSVcXFxcLmNka1xcXFxjZGstZG9ja2VyLWNyZWRzLmpzb25gLFxuICBdO1xuXG4gIGNvbnN0IGxpbnV4Q29tbWFuZHMgPSBbXG4gICAgJ21rZGlyICRIT01FLy5jZGsnLFxuICAgIGBlY2hvICcke0pTT04uc3RyaW5naWZ5KGNka0Fzc2V0c0NvbmZpZ0ZpbGUpfScgPiAkSE9NRS8uY2RrL2Nkay1kb2NrZXItY3JlZHMuanNvbmAsXG4gIF07XG5cbiAgaWYgKG9zVHlwZSA9PT0gJ2JvdGgnKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIC8vIFRoZXNlIHRhZ3MgYXJlIG1hZ2ljIGFuZCB3aWxsIGJlIHN0cmlwcGVkIHdoZW4gcmVuZGVyaW5nIHRoZSBwcm9qZWN0XG4gICAgICAuLi53aW5kb3dzQ29tbWFuZHMubWFwKGMgPT4gYCFXSU5ET1dTISR7Y31gKSxcbiAgICAgIC4uLmxpbnV4Q29tbWFuZHMubWFwKGMgPT4gYCFMSU5VWCEke2N9YCksXG4gICAgXTtcbiAgfSBlbHNlIGlmIChvc1R5cGUgPT09IGVjMi5PcGVyYXRpbmdTeXN0ZW1UeXBlLldJTkRPV1MpIHtcbiAgICByZXR1cm4gd2luZG93c0NvbW1hbmRzO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBsaW51eENvbW1hbmRzO1xuICB9XG59XG4iXX0=